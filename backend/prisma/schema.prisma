// Prisma Schema for AstroMedia v2.0
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("NEON_DATABASE_URL")
  directUrl = env("NEON_DATABASE_URL_DIRECT") // For migrations
}

// =====================
// USER & AUTH
// =====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  company       String?
  role          UserRole  @default(USER)
  apiQuota      Int       @default(1000) // Monthly API call quota
  apiUsed       Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  campaigns     Campaign[]
  apiKeys       ApiKey[]
  usage         UsageLog[]

  @@index([email])
}

enum UserRole {
  USER
  ADMIN
  ENTERPRISE
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  keyHash     String   @unique
  keyPrefix   String   // First 8 chars for display (e.g., "sk_live_abc123...")

  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([keyHash])
}

// =====================
// CAMPAIGNS
// =====================

model Campaign {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  status          CampaignStatus @default(DRAFT)
  governanceMode  GovernanceMode @default(SEMI_AUTO)

  // Brief data (JSON)
  briefData       Json

  // Campaign context
  brandProfile    String
  goals           String[]
  targetAudience  String
  budget          Decimal        @db.Decimal(10, 2)
  currency        String         @default("USD")
  timeline        String

  // Workflow state
  currentPhase    String?
  phaseStatuses   Json           @default("{}") // Record<phaseId, PhaseStatus>
  contextData     Json           @default("{}") // Orchestrator context

  // Metrics
  totalCost       Decimal        @db.Decimal(10, 6) @default(0)
  startedAt       DateTime?
  completedAt     DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  phases          CampaignPhase[]
  assets          Asset[]
  logs            CampaignLog[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum CampaignStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum GovernanceMode {
  GUIDED      // Full human validation
  SEMI_AUTO   // Key checkpoints only
  AUTO        // Fully automated
}

model CampaignPhase {
  id            String       @id @default(cuid())
  campaignId    String
  campaign      Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  phaseId       String       // e.g., "strategy", "seo", "designer"
  agentId       String       // Agent responsible
  status        PhaseStatus  @default(IDLE)

  inputData     Json?
  outputData    Json?

  attemptCount  Int          @default(0)
  maxRetries    Int          @default(3)

  startedAt     DateTime?
  completedAt   DateTime?
  latencyMs     Int?

  cost          Decimal      @db.Decimal(10, 6) @default(0)
  modelUsed     String?

  errorMessage  String?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([campaignId])
  @@index([phaseId])
  @@index([status])
}

enum PhaseStatus {
  IDLE
  READY
  RUNNING
  WAITING_VALIDATION
  COMPLETED
  FAILED
  SKIPPED
}

// =====================
// ASSETS (Images, Videos, Content)
// =====================

model Asset {
  id            String      @id @default(cuid())
  campaignId    String
  campaign      Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  type          AssetType
  category      String      // e.g., "visual_A", "visual_B", "video_narrative"

  // Content
  title         String?
  description   String?
  content       String?     @db.Text // For text assets

  // File storage
  fileUrl       String?     // GCS/S3 URL
  thumbnailUrl  String?
  mimeType      String?
  fileSize      Int?

  // Metadata
  metadata      Json?       // Model used, prompt, etc.

  // Validation
  status        AssetStatus @default(PENDING)
  validatedAt   DateTime?
  validatedBy   String?     // userId

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([campaignId])
  @@index([type])
  @@index([status])
}

enum AssetType {
  IMAGE
  VIDEO
  TEXT
  CAPTION
  HASHTAGS
  SCRIPT
  VOICEOVER
}

enum AssetStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

// =====================
// LOGGING & ANALYTICS
// =====================

model CampaignLog {
  id            String   @id @default(cuid())
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  level         LogLevel @default(INFO)
  action        String
  message       String?  @db.Text

  phaseId       String?
  agentId       String?

  metadata      Json?

  timestamp     DateTime @default(now())

  @@index([campaignId])
  @@index([timestamp])
  @@index([level])
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

model UsageLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Request info
  endpoint      String
  method        String
  statusCode    Int

  // LLM usage
  provider      String?
  model         String?
  tokensIn      Int      @default(0)
  tokensOut     Int      @default(0)
  latencyMs     Int?

  // Cost tracking
  cost          Decimal  @db.Decimal(10, 6) @default(0)

  // Metadata
  userAgent     String?
  ipAddress     String?

  timestamp     DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
}

// =====================
// KNOWLEDGE BASE (RAG)
// =====================

model KnowledgeFile {
  id            String   @id @default(cuid())
  userId        String

  name          String
  fileUrl       String   // GCS storage URL
  mimeType      String
  fileSize      Int

  // Embeddings (for future RAG implementation)
  isProcessed   Boolean  @default(false)
  chunkCount    Int      @default(0)

  createdAt     DateTime @default(now())

  @@index([userId])
}

// =====================
// SYSTEM METRICS
// =====================

model SystemMetric {
  id            String   @id @default(cuid())

  metricName    String
  metricValue   Float
  labels        Json?    // Additional dimensions

  timestamp     DateTime @default(now())

  @@index([metricName])
  @@index([timestamp])
}

// =====================
// INSTAGRAM AUTOMATION
// =====================

// Multi-platform social media interactions
model SocialInteraction {
  id              String           @id @default(cuid())
  platform        SocialPlatform   // instagram, facebook, linkedin, tiktok, twitter
  messageId       String           @map("message_id")
  senderId        String           @map("sender_id")
  messageText     String?          @map("message_text") @db.Text
  replyText       String?          @map("reply_text") @db.Text
  sentiment       String?          // positive, neutral, negative
  aiCost          Decimal?         @map("ai_cost") @db.Decimal(10, 6)
  responseTimeMs  Int?             @map("response_time_ms")
  timestamp       DateTime?
  metadata        Json?            // Platform-specific data (e.g., type: comment/dm for TikTok)
  createdAt       DateTime         @default(now()) @map("created_at")

  @@unique([platform, messageId]) // Composite unique constraint
  @@index([platform])
  @@index([senderId])
  @@index([timestamp(sort: Desc)])
  @@index([sentiment])
  @@index([platform, senderId]) // Query by platform+user
  @@map("social_interactions")
}

enum SocialPlatform {
  instagram
  facebook
  linkedin
  tiktok
  twitter
}

// Backward compatibility: Keep old table for existing data
model InstagramInteraction {
  id              String    @id @default(cuid())
  messageId       String    @unique @map("message_id")
  senderId        String    @map("sender_id")
  messageText     String?   @map("message_text") @db.Text
  replyText       String?   @map("reply_text") @db.Text
  sentiment       String?   // positive, neutral, negative
  aiCost          Decimal?  @map("ai_cost") @db.Decimal(10, 6)
  responseTimeMs  Int?      @map("response_time_ms")
  timestamp       DateTime?
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([senderId])
  @@index([timestamp(sort: Desc)])
  @@index([sentiment])
  @@map("instagram_interactions")
}

// Multi-platform lead tracking
model LeadProfile {
  id                String         @id @default(cuid())
  platformUserId    String         @unique @map("platform_user_id") // Format: "platform:userId" (e.g., "instagram:123")
  platform          String         // instagram, facebook, linkedin, tiktok, twitter

  // Legacy field for backward compatibility
  instagramUserId   String?        @map("instagram_user_id")

  // Profile data
  username          String?
  displayName       String?        @map("display_name")
  businessName      String?        @map("business_name")
  industry          String?
  location          String?
  followerCount     Int?           @map("follower_count")
  engagementRate    Decimal?       @map("engagement_rate") @db.Decimal(5, 2)
  lastPostDate      DateTime?      @map("last_post_date") @db.Date

  // Engagement metrics
  engagementScore   Int            @default(0) @map("engagement_score")
  totalInteractions Int            @default(0) @map("total_interactions")
  leadStatus        LeadStatus     @default(NEW) @map("lead_status")

  // Additional info
  notes             String?        @db.Text
  tags              String[]       @default([])

  // Timestamps
  discoveredAt      DateTime       @default(now()) @map("discovered_at")
  lastInteraction   DateTime?      @map("last_interaction")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  @@index([platformUserId])
  @@index([platform])
  @@index([instagramUserId])
  @@index([engagementScore(sort: Desc)])
  @@index([leadStatus])
  @@index([platform, leadStatus])
  @@map("lead_profiles")
}

enum LeadStatus {
  NEW
  CONTACTED
  ENGAGED
  QUALIFIED
  CONVERTED
  LOST
}

// =====================
// CMO AGENT REPORTS
// =====================

model CmoReport {
  id            String   @id @default(cuid())
  companyName   String   @map("company_name")
  reportData    Json     @map("report_data")
  totalAiCost   Decimal? @map("total_ai_cost") @db.Decimal(10, 6)
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([createdAt(sort: Desc)])
  @@map("cmo_reports")
}

// =====================
// QUEUE JOBS TRACKING (Replaces n8n)
// =====================

model QueueJob {
  id              String    @id @default(cuid())
  queueName       String    @map("queue_name") // instagram, lead-gen, content-scheduler
  jobId           String    @unique @map("job_id") // BullMQ job ID
  jobData         Json      @map("job_data")
  status          String    @default("pending") // pending, active, completed, failed
  progress        Int       @default(0)
  result          Json?
  errorMessage    String?   @map("error_message") @db.Text
  attemptsMade    Int       @default(0) @map("attempts_made")
  maxAttempts     Int       @default(3) @map("max_attempts")
  createdAt       DateTime  @default(now()) @map("created_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  @@index([queueName])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("queue_jobs")
}
