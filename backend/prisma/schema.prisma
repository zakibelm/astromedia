// Prisma Schema for AstroMedia v2.0
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("NEON_DATABASE_URL")
  directUrl = env("NEON_DATABASE_URL_DIRECT") // For migrations
}

// =====================
// USER & AUTH
// =====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  company       String?
  role          UserRole  @default(USER)
  apiQuota      Int       @default(1000) // Monthly API call quota
  apiUsed       Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  campaigns     Campaign[]
  apiKeys       ApiKey[]
  usage         UsageLog[]
  aiAgents      AIAgent[]
  workflows     Workflow[]

  @@index([email])
}

enum UserRole {
  USER
  ADMIN
  ENTERPRISE
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  keyHash     String   @unique
  keyPrefix   String   // First 8 chars for display (e.g., "sk_live_abc123...")

  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([keyHash])
}

// =====================
// CAMPAIGNS
// =====================

model Campaign {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  status          CampaignStatus @default(DRAFT)
  governanceMode  GovernanceMode @default(SEMI_AUTO)

  // Brief data (JSON)
  briefData       Json

  // Campaign context
  brandProfile    String
  goals           String[]
  targetAudience  String
  budget          Decimal        @db.Decimal(10, 2)
  currency        String         @default("USD")
  timeline        String

  // Workflow state
  currentPhase    String?
  phaseStatuses   Json           @default("{}") // Record<phaseId, PhaseStatus>
  contextData     Json           @default("{}") // Orchestrator context

  // Metrics
  totalCost       Decimal        @db.Decimal(10, 6) @default(0)
  startedAt       DateTime?
  completedAt     DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  phases          CampaignPhase[]
  assets          Asset[]
  logs            CampaignLog[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum CampaignStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum GovernanceMode {
  GUIDED      // Full human validation
  SEMI_AUTO   // Key checkpoints only
  AUTO        // Fully automated
}

model CampaignPhase {
  id            String       @id @default(cuid())
  campaignId    String
  campaign      Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  phaseId       String       // e.g., "strategy", "seo", "designer"
  agentId       String       // Agent responsible
  status        PhaseStatus  @default(IDLE)

  inputData     Json?
  outputData    Json?

  attemptCount  Int          @default(0)
  maxRetries    Int          @default(3)

  startedAt     DateTime?
  completedAt   DateTime?
  latencyMs     Int?

  cost          Decimal      @db.Decimal(10, 6) @default(0)
  modelUsed     String?

  errorMessage  String?

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([campaignId])
  @@index([phaseId])
  @@index([status])
}

enum PhaseStatus {
  IDLE
  READY
  RUNNING
  WAITING_VALIDATION
  COMPLETED
  FAILED
  SKIPPED
}

// =====================
// ASSETS (Images, Videos, Content)
// =====================

model Asset {
  id            String      @id @default(cuid())
  campaignId    String
  campaign      Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  type          AssetType
  category      String      // e.g., "visual_A", "visual_B", "video_narrative"

  // Content
  title         String?
  description   String?
  content       String?     @db.Text // For text assets

  // File storage
  fileUrl       String?     // GCS/S3 URL
  thumbnailUrl  String?
  mimeType      String?
  fileSize      Int?

  // Metadata
  metadata      Json?       // Model used, prompt, etc.

  // Validation
  status        AssetStatus @default(PENDING)
  validatedAt   DateTime?
  validatedBy   String?     // userId

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([campaignId])
  @@index([type])
  @@index([status])
}

enum AssetType {
  IMAGE
  VIDEO
  TEXT
  CAPTION
  HASHTAGS
  SCRIPT
  VOICEOVER
}

enum AssetStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

// =====================
// LOGGING & ANALYTICS
// =====================

model CampaignLog {
  id            String   @id @default(cuid())
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  level         LogLevel @default(INFO)
  action        String
  message       String?  @db.Text

  phaseId       String?
  agentId       String?

  metadata      Json?

  timestamp     DateTime @default(now())

  @@index([campaignId])
  @@index([timestamp])
  @@index([level])
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

model UsageLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Request info
  endpoint      String
  method        String
  statusCode    Int

  // LLM usage
  provider      String?
  model         String?
  tokensIn      Int      @default(0)
  tokensOut     Int      @default(0)
  latencyMs     Int?

  // Cost tracking
  cost          Decimal  @db.Decimal(10, 6) @default(0)

  // Metadata
  userAgent     String?
  ipAddress     String?

  timestamp     DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
}

// =====================
// KNOWLEDGE BASE (RAG)
// =====================

model KnowledgeFile {
  id            String   @id @default(cuid())
  userId        String

  name          String
  fileUrl       String   // GCS storage URL
  mimeType      String
  fileSize      Int

  // Embeddings (for future RAG implementation)
  isProcessed   Boolean  @default(false)
  chunkCount    Int      @default(0)

  createdAt     DateTime @default(now())
  
  agentId       String?
  agent         AIAgent? @relation(fields: [agentId], references: [id])

  @@index([userId])
}

// =====================
// SYSTEM METRICS
// =====================

model SystemMetric {
  id            String   @id @default(cuid())

  metricName    String
  metricValue   Float
  labels        Json?    // Additional dimensions

  timestamp     DateTime @default(now())

  @@index([metricName])
  @@index([timestamp])
}

// =====================
// INSTAGRAM AUTOMATION
// =====================

// Multi-platform social media interactions
model SocialInteraction {
  id              String           @id @default(cuid())
  platform        SocialPlatform   // instagram, facebook, linkedin, tiktok, twitter
  messageId       String           @map("message_id")
  senderId        String           @map("sender_id")
  messageText     String?          @map("message_text") @db.Text
  replyText       String?          @map("reply_text") @db.Text
  sentiment       String?          // positive, neutral, negative
  aiCost          Decimal?         @map("ai_cost") @db.Decimal(10, 6)
  responseTimeMs  Int?             @map("response_time_ms")
  timestamp       DateTime?
  metadata        Json?            // Platform-specific data (e.g., type: comment/dm for TikTok)
  createdAt       DateTime         @default(now()) @map("created_at")

  @@unique([platform, messageId]) // Composite unique constraint
  @@index([platform])
  @@index([senderId])
  @@index([timestamp(sort: Desc)])
  @@index([sentiment])
  @@index([platform, senderId]) // Query by platform+user
  @@map("social_interactions")
}

enum SocialPlatform {
  instagram
  facebook
  linkedin
  tiktok
  twitter
}

// Backward compatibility: Keep old table for existing data
model InstagramInteraction {
  id              String    @id @default(cuid())
  messageId       String    @unique @map("message_id")
  senderId        String    @map("sender_id")
  messageText     String?   @map("message_text") @db.Text
  replyText       String?   @map("reply_text") @db.Text
  sentiment       String?   // positive, neutral, negative
  aiCost          Decimal?  @map("ai_cost") @db.Decimal(10, 6)
  responseTimeMs  Int?      @map("response_time_ms")
  timestamp       DateTime?
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([senderId])
  @@index([timestamp(sort: Desc)])
  @@index([sentiment])
  @@map("instagram_interactions")
}

// Multi-platform lead tracking
model LeadProfile {
  id                String         @id @default(cuid())
  platformUserId    String         @unique @map("platform_user_id") // Format: "platform:userId" (e.g., "instagram:123")
  platform          String         // instagram, facebook, linkedin, tiktok, twitter

  // Legacy field for backward compatibility
  instagramUserId   String?        @map("instagram_user_id")

  // Profile data
  username          String?
  displayName       String?        @map("display_name")
  businessName      String?        @map("business_name")
  industry          String?
  location          String?
  followerCount     Int?           @map("follower_count")
  engagementRate    Decimal?       @map("engagement_rate") @db.Decimal(5, 2)
  lastPostDate      DateTime?      @map("last_post_date") @db.Date

  // Engagement metrics
  engagementScore   Int            @default(0) @map("engagement_score")
  totalInteractions Int            @default(0) @map("total_interactions")
  leadStatus        LeadStatus     @default(NEW) @map("lead_status")

  // Additional info
  notes             String?        @db.Text
  tags              String[]       @default([])

  // Timestamps
  discoveredAt      DateTime       @default(now()) @map("discovered_at")
  lastInteraction   DateTime?      @map("last_interaction")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  @@index([platformUserId])
  @@index([platform])
  @@index([instagramUserId])
  @@index([engagementScore(sort: Desc)])
  @@index([leadStatus])
  @@index([platform, leadStatus])
  @@map("lead_profiles")
}

enum LeadStatus {
  NEW
  CONTACTED
  ENGAGED
  QUALIFIED
  CONVERTED
  LOST
}

// =====================
// CMO AGENT REPORTS
// =====================

model CmoReport {
  id            String   @id @default(cuid())
  companyName   String   @map("company_name")
  reportData    Json     @map("report_data")
  totalAiCost   Decimal? @map("total_ai_cost") @db.Decimal(10, 6)
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([createdAt(sort: Desc)])
  @@map("cmo_reports")
}

// =====================
// QUEUE JOBS TRACKING (Replaces n8n)
// =====================

model QueueJob {
  id              String    @id @default(cuid())
  queueName       String    @map("queue_name") // instagram, lead-gen, content-scheduler
  jobId           String    @unique @map("job_id") // BullMQ job ID
  jobData         Json      @map("job_data")
  status          String    @default("pending") // pending, active, completed, failed
  progress        Int       @default(0)
  result          Json?
  errorMessage    String?   @map("error_message") @db.Text
  attemptsMade    Int       @default(0) @map("attempts_made")
  maxAttempts     Int       @default(3) @map("max_attempts")
  createdAt       DateTime  @default(now()) @map("created_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  @@index([queueName])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("queue_jobs")
}

// =====================
// AI AGENTS (Phase 1 & 2)
// =====================

// Community Manager Agent - Interactions tracking
model AgentCommunityInteraction {
  id              String    @id @default(cuid())
  comment         String    @db.Text
  response        String    @db.Text
  action          String    // reply, like, share, moderate, escalate
  platform        String    // linkedin, instagram, facebook, twitter, tiktok
  author          String?
  sentiment       String?   // positive, neutral, negative
  priority        String?   // low, medium, high, urgent
  requiresHuman   Boolean   @default(false) @map("requires_human")
  responseTime    Float?    @map("response_time_seconds")

  // Relationships
  campaignId      String?   @map("campaign_id")
  leadId          String?   @map("lead_id")

  // Metadata
  context         Json?

  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([platform])
  @@index([sentiment])
  @@index([priority])
  @@index([requiresHuman])
  @@index([createdAt(sort: Desc)])
  @@map("agent_community_interactions")
}

// SEO/AIO Agent - Content optimizations
model AgentSEOOptimization {
  id                    String    @id @default(cuid())
  contentPreview        String    @db.Text @map("content_preview")
  industry              String
  contentType           String    @map("content_type") // article, post, landing_page

  // SEO Data
  primaryKeywords       Json      @map("primary_keywords")
  secondaryKeywords     Json      @map("secondary_keywords")
  seoTitle              String?   @map("seo_title")
  metaDescription       String?   @map("meta_description") @db.Text

  // AIO Data
  factualAccuracyScore  Int       @map("factual_accuracy_score") // 0-100
  citationReadiness     Boolean   @default(false) @map("citation_readiness")
  eeatScore             Int?      @map("eeat_score") // 0-100
  citationExcerpts      Json?     @map("citation_excerpts")

  // Relationships
  campaignId            String?   @map("campaign_id")

  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([industry])
  @@index([contentType])
  @@index([factualAccuracyScore])
  @@index([createdAt(sort: Desc)])
  @@map("agent_seo_optimizations")
}

// Compliance Agent - Legal audits
model AgentComplianceAudit {
  id                 String    @id @default(cuid())
  contentType        String    @map("content_type") // email, post, landing_page, ad
  status             String    // compliant, minor_issues, major_issues, critical
  riskLevel          String    @map("risk_level") // low, medium, high, critical
  safeToPublish      Boolean   @map("safe_to_publish")

  // Violations
  violationsCount    Int       @default(0) @map("violations_count")
  violationsDetails  Json?     @map("violations_details")

  // Regions & Checks
  targetRegions      Json      @map("target_regions") // ["CA", "EU", "US"]
  checksPerformed    Json      @map("checks_performed") // ["CASL", "RGPD"]

  // Corrections
  correctedVersion   String?   @db.Text @map("corrected_version")
  requiredMentions   Json?     @map("required_mentions")

  // Relationships
  campaignId         String?   @map("campaign_id")
  reviewedByHuman    Boolean   @default(false) @map("reviewed_by_human")

  createdAt          DateTime  @default(now()) @map("created_at")

  @@index([status])
  @@index([riskLevel])
  @@index([safeToPublish])
  @@index([createdAt(sort: Desc)])
  @@map("agent_compliance_audits")
}

// Trend Scout Agent - Detected trends
model AgentTrend {
  id                 String    @id @default(cuid())
  title              String
  description        String    @db.Text
  industry           String

  // Metrics
  viralityScore      Int       @map("virality_score") // 0-100
  relevanceScore     Int       @map("relevance_score") // 0-100
  velocity           String?   // "mentions/hour"
  volume             Int?      // total mentions
  engagementRate     Float?    @map("engagement_rate")

  // Characteristics
  source             String    // twitter, linkedin, tiktok, google_trends
  hashtags           Json?
  durability         String?   // ephemeral, short-term, long-term

  // Opportunity
  recommendedAction  String?   @db.Text @map("recommended_action")
  recommendedFormat  String?   @map("recommended_format") // video, carousel, thread
  recommendedTiming  String?   @map("recommended_timing") // now, today, this_week
  estimatedReach     String?   @map("estimated_reach") // 10K, 100K, 1M+
  difficulty         String?   // easy, medium, hard

  // Tracking
  detectedAt         DateTime  @default(now()) @map("detected_at")
  actedUpon          Boolean   @default(false) @map("acted_upon")
  timeframe          String?   // 24h, 7d, 30d

  @@index([industry])
  @@index([viralityScore])
  @@index([relevanceScore])
  @@index([actedUpon])
  @@index([detectedAt(sort: Desc)])
  @@map("agent_trends")
}

// Crisis Manager Agent - Crisis alerts
model AgentCrisisAlert {
  id                   String    @id @default(cuid())
  brand                String
  crisisScore          Int       @map("crisis_score") // 0-100
  severity             String    // normal, watch, alert, crisis
  crisisType           String    @map("crisis_type") // product, service, employee, security

  // Sentiment Analysis
  sentimentPositive    Float?    @map("sentiment_positive")
  sentimentNeutral     Float?    @map("sentiment_neutral")
  sentimentNegative    Float?    @map("sentiment_negative")
  sentimentTrend       String?   @map("sentiment_trend") // improving, stable, worsening

  // Key Info
  keyIssues            Json?     @map("key_issues")
  amplifiers           Json?     // Influencers, media, hashtags

  // Actions
  recommendedActions   Json?     @map("recommended_actions")
  statementDraft       String?   @db.Text @map("statement_draft")
  escalationRequired   Boolean   @default(false) @map("escalation_required")

  // Impact
  reputationDamage     String?   @map("reputation_damage") // low, medium, high, severe
  financialRisk        String?   @map("financial_risk") // low, medium, high
  recoveryTime         String?   @map("recovery_time") // days, weeks, months

  // Status
  status               String    @default("open") // open, monitoring, resolved
  resolvedAt           DateTime? @map("resolved_at")
  monitoringFrequency  String?   @map("monitoring_frequency") // 15min, 1h, 4h, daily

  // Tracking
  detectedAt           DateTime  @default(now()) @map("detected_at")
  lastUpdated          DateTime  @updatedAt @map("last_updated")

  @@index([brand])
  @@index([severity])
  @@index([status])
  @@index([escalationRequired])
  @@index([detectedAt(sort: Desc)])
  @@map("agent_crisis_alerts")
}

// Agent Performance Metrics
model AgentMetrics {
  id                String    @id @default(cuid())
  agentType         String    @map("agent_type") // community_manager, seo_aio, compliance, trend_scout, crisis_manager

  // Counts
  totalCalls        Int       @default(0) @map("total_calls")
  successfulCalls   Int       @default(0) @map("successful_calls")
  failedCalls       Int       @default(0) @map("failed_calls")

  // Performance
  avgResponseTime   Float     @default(0) @map("avg_response_time") // seconds
  minResponseTime   Float?    @map("min_response_time")
  maxResponseTime   Float?    @map("max_response_time")

  // Dates
  lastExecution     DateTime? @map("last_execution")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Period (for time-based analytics)
  period            String    @default("all_time") // daily, weekly, monthly, all_time

  @@unique([agentType, period])
  @@index([agentType])
  @@index([period])
  @@map("agent_metrics")
}

// =====================
// GALLERY SYSTEM (User-Defined)
// =====================

model AIAgent {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  role          String
  model         String   // gpt-4, claude-3, etc.
  systemPrompt  String   @db.Text
  avatarUrl     String?

  // RAG Configuration
  ragEnabled    Boolean  @default(false)
  // Simple relation for V1 - knowledgeFiles associated with this agent
  knowledgeFiles KnowledgeFile[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

model Workflow {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  description   String?
  steps         Json     // Array of steps config
  
  // Orchestrator Config
  orchestratorPrompt String? @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}
