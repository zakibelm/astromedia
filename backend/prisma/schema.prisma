generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("NEON_DATABASE_URL")
  directUrl = env("NEON_DATABASE_URL_DIRECT")
}

model ApiKey {
  id         String    @id
  userId     String
  name       String
  keyHash    String    @unique
  keyPrefix  String
  lastUsedAt DateTime?
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  User       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

model Asset {
  id           String      @id
  campaignId   String
  type         AssetType
  category     String
  title        String?
  description  String?
  content      String?
  fileUrl      String?
  thumbnailUrl String?
  mimeType     String?
  fileSize     Int?
  metadata     Json?
  status       AssetStatus @default(PENDING)
  validatedAt  DateTime?
  validatedBy  String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  Campaign     Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([status])
  @@index([type])
}

model Campaign {
  id             String          @id
  userId         String
  name           String
  status         CampaignStatus  @default(DRAFT)
  governanceMode GovernanceMode  @default(SEMI_AUTO)
  briefData      Json
  brandProfile   String
  goals          String[]
  targetAudience String
  budget         Decimal         @db.Decimal(10, 2)
  currency       String          @default("USD")
  timeline       String
  currentPhase   String?
  phaseStatuses  Json            @default("{}")
  contextData    Json            @default("{}")
  totalCost      Decimal         @default(0) @db.Decimal(10, 6)
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  Asset          Asset[]
  User           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  CampaignLog    CampaignLog[]
  CampaignPhase  CampaignPhase[]

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model CampaignLog {
  id         String   @id
  campaignId String
  level      LogLevel @default(INFO)
  action     String
  message    String?
  phaseId    String?
  agentId    String?
  metadata   Json?
  timestamp  DateTime @default(now())
  Campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([level])
  @@index([timestamp])
}

model CampaignPhase {
  id           String      @id
  campaignId   String
  phaseId      String
  agentId      String
  status       PhaseStatus @default(IDLE)
  inputData    Json?
  outputData   Json?
  attemptCount Int         @default(0)
  maxRetries   Int         @default(3)
  startedAt    DateTime?
  completedAt  DateTime?
  latencyMs    Int?
  cost         Decimal     @default(0) @db.Decimal(10, 6)
  modelUsed    String?
  errorMessage String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  Campaign     Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([phaseId])
  @@index([status])
}

model KnowledgeFile {
  id          String   @id
  userId      String
  name        String
  fileUrl     String
  mimeType    String
  fileSize    Int
  isProcessed Boolean  @default(false)
  chunkCount  Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([userId])
}

model SystemMetric {
  id          String   @id
  metricName  String
  metricValue Float
  labels      Json?
  timestamp   DateTime @default(now())

  @@index([metricName])
  @@index([timestamp])
}

model UsageLog {
  id         String   @id
  userId     String
  endpoint   String
  method     String
  statusCode Int
  provider   String?
  model      String?
  tokensIn   Int      @default(0)
  tokensOut  Int      @default(0)
  latencyMs  Int?
  cost       Decimal  @default(0) @db.Decimal(10, 6)
  userAgent  String?
  ipAddress  String?
  timestamp  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([timestamp])
  @@index([userId])
}

model User {
  id           String     @id
  email        String     @unique
  passwordHash String
  name         String?
  company      String?
  role         UserRole   @default(USER)
  apiQuota     Int        @default(1000)
  apiUsed      Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  lastLoginAt  DateTime?
  ApiKey       ApiKey[]
  Campaign     Campaign[]
  UsageLog     UsageLog[]

  @@index([email])
}

model agent_community_interactions {
  id                    String   @id
  comment               String
  response              String
  action                String
  platform              String
  author                String?
  sentiment             String?
  priority              String?
  requires_human        Boolean  @default(false)
  response_time_seconds Float?
  campaign_id           String?
  lead_id               String?
  context               Json?
  created_at            DateTime @default(now())

  @@index([created_at(sort: Desc)])
  @@index([platform])
  @@index([priority])
  @@index([requires_human])
  @@index([sentiment])
}

model agent_compliance_audits {
  id                 String   @id
  content_type       String
  status             String
  risk_level         String
  safe_to_publish    Boolean
  violations_count   Int      @default(0)
  violations_details Json?
  target_regions     Json
  checks_performed   Json
  corrected_version  String?
  required_mentions  Json?
  campaign_id        String?
  reviewed_by_human  Boolean  @default(false)
  created_at         DateTime @default(now())

  @@index([created_at(sort: Desc)])
  @@index([risk_level])
  @@index([safe_to_publish])
  @@index([status])
}

model agent_crisis_alerts {
  id                   String    @id
  brand                String
  crisis_score         Int
  severity             String
  crisis_type          String
  sentiment_positive   Float?
  sentiment_neutral    Float?
  sentiment_negative   Float?
  sentiment_trend      String?
  key_issues           Json?
  amplifiers           Json?
  recommended_actions  Json?
  statement_draft      String?
  escalation_required  Boolean   @default(false)
  reputation_damage    String?
  financial_risk       String?
  recovery_time        String?
  status               String    @default("open")
  resolved_at          DateTime?
  monitoring_frequency String?
  detected_at          DateTime  @default(now())
  last_updated         DateTime

  @@index([brand])
  @@index([detected_at(sort: Desc)])
  @@index([escalation_required])
  @@index([severity])
  @@index([status])
}

model agent_metrics {
  id                String    @id
  agent_type        String
  total_calls       Int       @default(0)
  successful_calls  Int       @default(0)
  failed_calls      Int       @default(0)
  avg_response_time Float     @default(0)
  min_response_time Float?
  max_response_time Float?
  last_execution    DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime
  period            String    @default("all_time")

  @@unique([agent_type, period])
  @@index([agent_type])
  @@index([period])
}

model agent_seo_optimizations {
  id                     String   @id
  content_preview        String
  industry               String
  content_type           String
  primary_keywords       Json
  secondary_keywords     Json
  seo_title              String?
  meta_description       String?
  factual_accuracy_score Int
  citation_readiness     Boolean  @default(false)
  eeat_score             Int?
  citation_excerpts      Json?
  campaign_id            String?
  created_at             DateTime @default(now())

  @@index([content_type])
  @@index([created_at(sort: Desc)])
  @@index([factual_accuracy_score])
  @@index([industry])
}

model agent_trends {
  id                 String   @id
  title              String
  description        String
  industry           String
  virality_score     Int
  relevance_score    Int
  velocity           String?
  volume             Int?
  engagement_rate    Float?
  source             String
  hashtags           Json?
  durability         String?
  recommended_action String?
  recommended_format String?
  recommended_timing String?
  estimated_reach    String?
  difficulty         String?
  detected_at        DateTime @default(now())
  acted_upon         Boolean  @default(false)
  timeframe          String?

  @@index([acted_upon])
  @@index([detected_at(sort: Desc)])
  @@index([industry])
  @@index([relevance_score])
  @@index([virality_score])
}

model cmo_reports {
  id            String   @id
  company_name  String
  report_data   Json
  total_ai_cost Decimal? @db.Decimal(10, 6)
  created_at    DateTime @default(now())

  @@index([created_at(sort: Desc)])
}

model instagram_interactions {
  id               String    @id
  message_id       String    @unique
  sender_id        String
  message_text     String?
  reply_text       String?
  sentiment        String?
  ai_cost          Decimal?  @db.Decimal(10, 6)
  response_time_ms Int?
  timestamp        DateTime?
  created_at       DateTime  @default(now())

  @@index([sender_id])
  @@index([sentiment])
  @@index([timestamp(sort: Desc)])
}

model lead_profiles {
  id                 String     @id
  platform_user_id   String     @unique
  platform           String
  instagram_user_id  String?
  username           String?
  display_name       String?
  business_name      String?
  industry           String?
  location           String?
  follower_count     Int?
  engagement_rate    Decimal?   @db.Decimal(5, 2)
  last_post_date     DateTime?  @db.Date
  engagement_score   Int        @default(0)
  total_interactions Int        @default(0)
  lead_status        LeadStatus @default(NEW)
  notes              String?
  tags               String[]   @default([])
  discovered_at      DateTime   @default(now())
  last_interaction   DateTime?
  created_at         DateTime   @default(now())
  updated_at         DateTime

  @@index([engagement_score(sort: Desc)])
  @@index([instagram_user_id])
  @@index([lead_status])
  @@index([platform])
  @@index([platform, lead_status])
  @@index([platform_user_id])
}

model queue_jobs {
  id            String    @id
  queue_name    String
  job_id        String    @unique
  job_data      Json
  status        String    @default("pending")
  progress      Int       @default(0)
  result        Json?
  error_message String?
  attempts_made Int       @default(0)
  max_attempts  Int       @default(3)
  created_at    DateTime  @default(now())
  started_at    DateTime?
  completed_at  DateTime?

  @@index([created_at(sort: Desc)])
  @@index([queue_name])
  @@index([status])
}

model social_interactions {
  id               String         @id
  platform         SocialPlatform
  message_id       String
  sender_id        String
  message_text     String?
  reply_text       String?
  sentiment        String?
  ai_cost          Decimal?       @db.Decimal(10, 6)
  response_time_ms Int?
  timestamp        DateTime?
  metadata         Json?
  created_at       DateTime       @default(now())

  @@unique([platform, message_id])
  @@index([platform])
  @@index([platform, sender_id])
  @@index([sender_id])
  @@index([sentiment])
  @@index([timestamp(sort: Desc)])
}

enum AssetStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

enum AssetType {
  IMAGE
  VIDEO
  TEXT
  CAPTION
  HASHTAGS
  SCRIPT
  VOICEOVER
}

enum CampaignStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum GovernanceMode {
  GUIDED
  SEMI_AUTO
  AUTO
}

enum LeadStatus {
  NEW
  CONTACTED
  ENGAGED
  QUALIFIED
  CONVERTED
  LOST
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

enum PhaseStatus {
  IDLE
  READY
  RUNNING
  WAITING_VALIDATION
  COMPLETED
  FAILED
  SKIPPED
}

enum SocialPlatform {
  instagram
  facebook
  linkedin
  tiktok
  twitter
}

enum UserRole {
  USER
  ADMIN
  ENTERPRISE
}
